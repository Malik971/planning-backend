# üéØ Planning Backend - API REST avec Firebase Auth & PostgreSQL

## üìã Vue d'ensemble

Back-end robuste pour application de planning avec authentification Firebase, gestion de r√¥les, et API REST compl√®te. Con√ßu pour g√©rer les √©v√©nements de planning multi-√©quipes avec s√©curit√© avanc√©e et tra√ßabilit√© compl√®te.

### ‚ú® Fonctionnalit√©s principales

- **Authentification Firebase** avec gestion des r√¥les (admin, manager, staff)
- **API REST compl√®te** pour la gestion d'√©v√©nements
- **Base PostgreSQL** avec migrations et seeds
- **Syst√®me d'audit** complet avec tra√ßabilit√©
- **Duplication de plannings** entre semaines
- **Templates de planning** r√©utilisables
- **Validation avanc√©e** des donn√©es
- **Rate limiting** et s√©curit√©
- **Logging structur√©** avec Winston

## üèóÔ∏è Architecture

```
src/
‚îú‚îÄ‚îÄ config/          # Configuration (DB, Firebase, env)
‚îú‚îÄ‚îÄ middleware/      # Auth, permissions, validation
‚îú‚îÄ‚îÄ services/        # Logique m√©tier (events, users, audit)
‚îú‚îÄ‚îÄ routes/          # Endpoints API REST
‚îî‚îÄ‚îÄ app.js          # Application Express principale
```

## üöÄ Installation et configuration

### 1. Pr√©requis

- **Node.js** >= 16.0.0
- **PostgreSQL** >= 12
- **Firebase** projet configur√©
- **Git**

### 2. Installation

```bash
# Cloner le projet
git clone <repository-url>
cd planning-backend

# Installer les d√©pendances
npm install

# Copier et configurer l'environnement
cp .env.example .env
# √âditer .env avec vos valeurs
```

### 3. Configuration de la base de donn√©es

```bash
# Cr√©er la base PostgreSQL
createdb planning_db

# Ex√©cuter les migrations
npm run migrate

# (Optionnel) Peupler avec des donn√©es de test
npm run seed
```

### 4. Configuration Firebase

1. Cr√©er un projet Firebase
2. G√©n√©rer une cl√© de compte de service
3. Activer Authentication et Firestore
4. Configurer les variables Firebase dans `.env`

### 5. D√©marrage

```bash
# D√©veloppement
npm run dev

# Production
npm start
```

## üîê Authentification et r√¥les

### Syst√®me de r√¥les

- **üî¥ Admin** : Acc√®s complet, gestion utilisateurs, toutes √©quipes
- **üü° Manager** : Cr√©ation/modification √©v√©nements, √©quipes assign√©es
- **üü¢ Staff** : Lecture seule, √©quipes assign√©es

### √âquipes disponibles

- `bar` - √âquipe bar
- `animation` - √âquipe animation  
- `reception` - √âquipe r√©ception

### Headers d'authentification

```
Authorization: Bearer <firebase-jwt-token>
```

## üì° API Endpoints

### üìÖ √âv√©nements (`/api/events`)

| M√©thode | Endpoint | R√¥le requis | Description |
|---------|----------|-------------|-------------|
| `GET` | `/api/events` | Tous | Liste des √©v√©nements avec filtres |
| `GET` | `/api/events/:id` | Tous | D√©tail d'un √©v√©nement |
| `POST` | `/api/events` | Admin/Manager | Cr√©er un √©v√©nement |
| `PUT` | `/api/events/:id` | Admin/Manager/Propri√©taire | Modifier un √©v√©nement |
| `DELETE` | `/api/events/:id` | Admin/Manager/Propri√©taire | Supprimer un √©v√©nement |
| `GET` | `/api/events/week/:date` | Tous | √âv√©nements d'une semaine |
| `POST` | `/api/events/conflicts/check` | Tous | V√©rifier les conflits |
| `GET` | `/api/events/stats/summary` | Tous | Statistiques |

#### Exemples d'utilisation

```javascript
// Cr√©er un √©v√©nement
POST /api/events
{
  "title": "Club enfants",
  "start_time": "2025-08-25T14:00:00.000Z",
  "end_time": "2025-08-25T15:30:00.000Z",
  "team": "animation",
  "animator": "Sophie",
  "color": "#FF6B6B",
  "description": "Activit√©s pour les 6-12 ans"
}

// R√©cup√©rer les √©v√©nements d'une √©quipe
GET /api/events?team=bar&start_date=2025-08-25&end_date=2025-08-31

// V√©rifier les conflits
POST /api/events/conflicts/check
{
  "start_time": "2025-08-25T14:00:00.000Z",
  "end_time": "2025-08-25T15:30:00.000Z",
  "team": "animation",
  "exclude_event_id": "uuid-optionnel"
}
```

### üë• Utilisateurs (`/api/users`)

| M√©thode | Endpoint | R√¥le requis | Description |
|---------|----------|-------------|-------------|
| `GET` | `/api/users/profile` | Tous | Mon profil |
| `PUT` | `/api/users/profile` | Tous | Modifier mon profil |
| `GET` | `/api/users` | Admin/Manager | Liste des utilisateurs |
| `GET` | `/api/users/:uid` | Admin/Manager | D√©tail utilisateur |
| `POST` | `/api/users` | Admin | Cr√©er un utilisateur |
| `PUT` | `/api/users/:uid` | Admin | Modifier un utilisateur |
| `DELETE` | `/api/users/:uid` | Admin | Supprimer un utilisateur |
| `PUT` | `/api/users/:uid/deactivate` | Admin | D√©sactiver un utilisateur |
| `PUT` | `/api/users/:uid/teams` | Admin | Assigner des √©quipes |
| `GET` | `/api/users/teams/:team` | Tous | Membres d'une √©quipe |

### üìã Planning (`/api/planning`)

| M√©thode | Endpoint | R√¥le requis | Description |
|---------|----------|-------------|-------------|
| `POST` | `/api/planning/duplicate` | Admin/Manager | Dupliquer une semaine |
| `GET` | `/api/planning/templates` | Tous | Templates de planning |
| `POST` | `/api/planning/templates` | Admin/Manager | Cr√©er un template |
| `POST` | `/api/planning/templates/:id/apply` | Admin/Manager | Appliquer un template |
| `GET` | `/api/planning/overview` | Tous | Vue d'ensemble multi-√©quipes |
| `POST` | `/api/planning/bulk-create` | Admin/Manager | Cr√©ation en masse |

#### Exemple de duplication

```javascript
// Dupliquer le planning d'une semaine
POST /api/planning/duplicate
{
  "source_week": "2025-08-25T00:00:00.000Z",
  "target_week": "2025-09-01T00:00:00.000Z", 
  "team": "animation",
  "overwrite": false
}
```

### üìä Audit (`/api/audit`) - Admin uniquement

| M√©thode | Endpoint | Description |
|---------|----------|-------------|
| `GET` | `/api/audit` | Logs d'audit avec filtres |
| `GET` | `/api/audit/stats` | Statistiques d'audit |
| `GET` | `/api/audit/export` | Export CSV des audits |

## üõ°Ô∏è S√©curit√©

### Middleware de s√©curit√©

- **Helmet** : Headers de s√©curit√© HTTP
- **CORS** : Configuration cross-origin
- **Rate limiting** : Protection contre le spam
- **Validation** : Sanitisation des donn√©es avec Joi
- **Audit logging** : Tra√ßabilit√© compl√®te des actions

### Validation des donn√©es

Tous les endpoints utilisent une validation stricte :

```javascript
// Exemple de sch√©ma d'√©v√©nement
{
  title: "String 1-200 caract√®res",
  start_time: "Date ISO requise",
  end_time: "Date ISO > start_time",
  team: "Enum: bar|animation|reception",
  animator: "String optionnel max 100",
  color: "Hex color #RRGGBB optionnel"
}
```

### Permissions granulaires

- **Acc√®s par √©quipe** : V√©rification automatique
- **Propri√©t√© des √©v√©nements** : Seuls les cr√©ateurs/managers peuvent modifier
- **Actions sensibles** : Logging obligatoire
- **Rate limiting strict** : 10 req/15min pour endpoints critiques

## üóÑÔ∏è Base de donn√©es

### Structure principale

```sql
-- Utilisateurs
users (
  uid PRIMARY KEY,           -- Firebase UID
  email UNIQUE NOT NULL,
  display_name,
  role ENUM('admin','manager','staff'),
  teams JSON DEFAULT '[]',   -- ['bar','animation']
  active BOOLEAN DEFAULT true
)

-- √âv√©nements
events (
  id UUID PRIMARY KEY,
  title NOT NULL,
  start_time TIMESTAMP NOT NULL,
  end_time TIMESTAMP NOT NULL,
  team ENUM('bar','animation','reception'),
  animator,
  color,
  description,
  metadata JSON,
  created_by REFERENCES users(uid),
  last_modified_by REFERENCES users(uid)
)

-- Audit complet
audit_logs (
  id SERIAL PRIMARY KEY,
  table_name NOT NULL,
  record_id NOT NULL, 
  action ENUM('CREATE','UPDATE','DELETE'),
  user_uid REFERENCES users(uid),
  old_values JSON,
  new_values JSON,
  ip_address,
  user_agent,
  created_at TIMESTAMP
)
```

### Migrations et seeds

```bash
# Nouvelle migration
npx knex migrate:make nom_migration

# Rollback
npx knex migrate:rollback

# Status
npx knex migrate:status
```

## üîß Configuration avanc√©e

### Variables d'environnement critiques

```bash
# Base de donn√©es
DB_HOST=localhost
DB_USER=planning_user
DB_PASSWORD=secure_password
DB_NAME=planning_db

# Firebase (depuis la console Firebase > Param√®tres > Comptes de service)
FIREBASE_PROJECT_ID=votre-projet-id
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
FIREBASE_CLIENT_EMAIL=firebase-adminsdk-xxxxx@votre-projet.iam.gserviceaccount.com

# S√©curit√©
FRONTEND_URL=http://localhost:3000  # URL de votre front
```

### Logging et monitoring

- **Winston** pour les logs structur√©s
- **Logs d'audit** automatiques pour toutes les modifications
- **Health check** sur `/health`
- **M√©triques** disponibles pour monitoring externe

### Performance

- **Indexation** optimis√©e des requ√™tes fr√©quentes
- **Pagination** automatique (max 100 r√©sultats)
- **Compression gzip** des r√©ponses
- **Connection pooling** PostgreSQL

## üß™ Tests et d√©veloppement

### Scripts disponibles

```bash
npm run dev          # D√©veloppement avec rechargement
npm start           # Production
npm run migrate     # Migrations DB
npm run seed        # Donn√©es de test
npm test           # Tests unitaires
npm run test:watch # Tests en mode watch
```

### Tests

```bash
# Tests unitaires
npm test

# Tests d'int√©gration avec base de test
NODE_ENV=test npm test

# Coverage
npm run test:coverage
```

## üöÄ D√©ploiement

### Production

```bash
# Variables d'environnement
NODE_ENV=production
PORT=3001
DATABASE_URL=postgresql://user:pass@host:port/db

# Commandes
npm run migrate
npm start
```

### Docker (optionnel)

```dockerfile
FROM node:16-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY src ./src
EXPOSE 3001
CMD ["npm", "start"]
```

## üìû Support et maintenance

### Monitoring recommand√©

- **Uptime** : Surveillance de `/health`
- **Erreurs** : Logs dans `logs/error.log`
- **Performance** : M√©triques de r√©ponse
- **Base de donn√©es** : Monitoring PostgreSQL

### Maintenance r√©guli√®re

```bash
# Nettoyage des anciens audits (90+ jours)
# Automatique ou manuel via l'API

# Sauvegarde base de donn√©es
pg_dump planning_db > backup_$(date +%Y%m%d).sql

# Rotation des logs
# Configuration logrotate recommand√©e
```

### Endpoints de maintenance

- `GET /health` - √âtat du serveur
- `GET /api/audit/stats` - Statistiques syst√®me
- Rate limiting adaptatif selon la charge

## ü§ù Int√©gration avec le front-end

### Format des r√©ponses

```javascript
// Succ√®s
{
  "success": true,
  "data": { ... },
  "pagination": { ... }  // Si applicable
}

// Erreur
{
  "error": "Type d'erreur",
  "message": "Message explicite",
  "details": [ ... ]     // Si applicable
}
```

### WebSocket (extension future)

L'architecture permet l'ajout facile de WebSocket pour :
- Notifications temps r√©el
- Synchronisation multi-utilisateurs
- Updates automatiques du planning

---

## üéØ Migration depuis Firestore

Si vous migrez depuis une solution Firestore existante :

1. **Export des donn√©es** : Scripts de migration disponibles
2. **Synchronisation** : Endpoint `/api/users/sync` pour migration utilisateurs
3. **Compatibilit√©** : Structure des √©v√©nements similaire
4. **Import en masse** : Endpoint `/api/planning/bulk-create`

Cette architecture back-end robuste assure une s√©curit√© maximale, une performance optimale, et une maintenance facilit√©e pour votre application de planning multi-√©quipes. üöÄ
